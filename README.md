# Essay Show - ä½œæ–‡æ‰¹æ”¹ç³»ç»Ÿ

åŸºäº Go-Zero æ¡†æ¶å¼€å‘çš„ä½œæ–‡æ™ºèƒ½æ‰¹æ”¹ç³»ç»Ÿï¼Œé‡‡ç”¨ DDD åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒå®æ—¶ä½œæ–‡æ‰¹æ”¹ã€PDFä¸‹è½½ã€ç¼“å­˜ä¼˜åŒ–ç­‰åŠŸèƒ½ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
essay-show/
â”œâ”€â”€ biz/                                    # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ adaptor/                           # é€‚é…å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ controller/                    # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ router/                        # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ extract.go                     # ç”¨æˆ·ä¿¡æ¯æå–
â”‚   â”œâ”€â”€ application/                       # åº”ç”¨æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ dto/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ basic/                    # åŸºç¡€DTO
â”‚   â”‚   â”‚   â””â”€â”€ essay/                    # ä½œæ–‡ç›¸å…³DTO
â”‚   â”‚   â””â”€â”€ service/                      # åº”ç”¨æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ essay.go                  # ä½œæ–‡æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ user.go                   # ç”¨æˆ·æœåŠ¡
â”‚   â”‚       â””â”€â”€ sts.go                    # ä¸´æ—¶å‡­è¯æœåŠ¡
â”‚   â””â”€â”€ infrastructure/                    # åŸºç¡€è®¾æ–½å±‚
â”‚       â”œâ”€â”€ config/                       # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ consts/                       # å¸¸é‡å®šä¹‰
â”‚       â”œâ”€â”€ repository/                   # æ•°æ®ä»“å‚¨å±‚
â”‚       â”‚   â”œâ”€â”€ user/                     # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚       â”‚   â”œâ”€â”€ log/                      # æ—¥å¿—æ•°æ®è®¿é—®
â”‚       â”‚   â”œâ”€â”€ exercise/                 # ç»ƒä¹ æ•°æ®è®¿é—®
â”‚       â”‚   â”œâ”€â”€ attend/                   # ç­¾åˆ°æ•°æ®è®¿é—®
â”‚       â”‚   â”œâ”€â”€ invitation/               # é‚€è¯·æ•°æ®è®¿é—®
â”‚       â”‚   â””â”€â”€ feedback/                 # åé¦ˆæ•°æ®è®¿é—®
â”‚       â”œâ”€â”€ cache/                        # ç¼“å­˜å±‚
â”‚       â”‚   â””â”€â”€ download_cache.go         # ä¸‹è½½ç¼“å­˜æœåŠ¡
â”‚       â”œâ”€â”€ lock/                         # åˆ†å¸ƒå¼é”å±‚
â”‚       â”‚   â””â”€â”€ distributed_lock.go       # åˆ†å¸ƒå¼é”æœåŠ¡
â”‚       â”œâ”€â”€ redis/                        # RedisåŸºç¡€è®¾æ–½
â”‚       â”‚   â””â”€â”€ redis.go                  # Redisè¿æ¥ç®¡ç†
â”‚       â””â”€â”€ util/                         # å·¥å…·ç±»
â”œâ”€â”€ provider/                              # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ provider.go                       # ä¾èµ–é…ç½®
â”‚   â”œâ”€â”€ wire.go                           # Wireé…ç½®
â”‚   â””â”€â”€ wire_gen.go                       # Wireç”Ÿæˆä»£ç 
â””â”€â”€ main.go                               # ç¨‹åºå…¥å£
```

## ğŸ—ï¸ DDD åˆ†å±‚æ¶æ„

### 1. è¡¨ç¤ºå±‚ (Presentation Layer)
- **ä½ç½®**: `biz/adaptor/`
- **èŒè´£**: å¤„ç†HTTPè¯·æ±‚å“åº”ã€è·¯ç”±é…ç½®ã€å‚æ•°éªŒè¯
- **ç»„ä»¶**: Controllerã€Routerã€Middleware

### 2. åº”ç”¨å±‚ (Application Layer)
- **ä½ç½®**: `biz/application/service/`
- **èŒè´£**: ä¸šåŠ¡é€»è¾‘ç¼–æ’ã€äº‹åŠ¡ç®¡ç†ã€ç¼“å­˜ç­–ç•¥
- **ç‰¹ç‚¹**: ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼Œåªè´Ÿè´£åè°ƒé¢†åŸŸå¯¹è±¡

### 3. åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
- **ä½ç½®**: `biz/infrastructure/`
- **èŒè´£**: æŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œæ•°æ®æŒä¹…åŒ–ã€ç¼“å­˜ã€å¤–éƒ¨APIè°ƒç”¨
- **ç»„ä»¶**: 
  - `repository/`: æ•°æ®ä»“å‚¨ï¼ˆMongoDBæ“ä½œï¼‰
  - `cache/`: ç¼“å­˜æœåŠ¡ï¼ˆRedisç¼“å­˜ï¼‰
  - `lock/`: åˆ†å¸ƒå¼é”æœåŠ¡ï¼ˆRedisé”ï¼‰
  - `redis/`: RedisåŸºç¡€è®¾æ–½ï¼ˆè¿æ¥ç®¡ç†ï¼‰
  - `util/`: æŠ€æœ¯å·¥å…·ç±»

### 4. ä¾èµ–æ³¨å…¥å±‚
- **ä½ç½®**: `provider/`
- **èŒè´£**: ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–å…³ç³»
- **å·¥å…·**: Google Wire

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ä½œæ–‡æ‰¹æ”¹
- **åŒæ­¥æ‰¹æ”¹**: `EssayEvaluate` - ä¼ ç»Ÿçš„åŒæ­¥æ‰¹æ”¹æ¥å£
- **æµå¼æ‰¹æ”¹**: `EssayEvaluateStream` - æ”¯æŒå®æ—¶è¿›åº¦åé¦ˆçš„æµå¼æ‰¹æ”¹
- **ç»“æœä¸‹è½½**: `DownloadEvaluate` - æ‰¹æ”¹ç»“æœPDFä¸‹è½½ï¼ˆæ”¯æŒç¼“å­˜ï¼‰

### 2. ç¼“å­˜ä¼˜åŒ– ğŸš€
#### Redis ç¼“å­˜æ¶æ„
```go
// ç¼“å­˜æ¥å£æŠ½è±¡
type IDownloadCacheMapper interface {
    Get(ctx context.Context, id string) (*show.DownloadEvaluateResp, error)
    Set(ctx context.Context, id string, data *show.DownloadEvaluateResp) error
    Delete(ctx context.Context, id string) error
}

// ç¼“å­˜å®ç°
type DownloadCacheMapper struct {
    rds *gozero_redis.Redis
}
```

#### ç¼“å­˜ç­–ç•¥
- **ç¼“å­˜Key**: `download_evaluate:{id}`
- **è¿‡æœŸæ—¶é—´**: 1å°æ—¶ (3600ç§’)
- **ç¼“å­˜åœºæ™¯**: PDFä¸‹è½½é“¾æ¥ç¼“å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨ä¸‹æ¸¸API
- **é™çº§ç­–ç•¥**: ç¼“å­˜å¤±è´¥ä¸å½±å“æ­£å¸¸ä¸šåŠ¡æµç¨‹

### 3. åˆ†å¸ƒå¼é” ğŸ”
#### åˆ†å¸ƒå¼é”æ¶æ„
```go
// åˆ†å¸ƒå¼é”å®ç°ï¼ˆä½äºlockåŒ…ä¸­ï¼‰
type EvaMutex struct {
    rds *gozero_redis.Redis  // é€šè¿‡redis.GetRedis()è·å–è¿æ¥
    key string
    value string    // å”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢è¯¯é‡Šæ”¾
    // ... å…¶ä»–å­—æ®µ
}

// ä½¿ç”¨æ–¹å¼
key := "evaluate" + userId
distributedLock := lock.NewEvaMutex(ctx, key, 20, 40)
if err := distributedLock.Lock(); err != nil {
    // å¤„ç†è·å–é”å¤±è´¥
}
defer distributedLock.Unlock()
```

#### é”ç‰¹æ€§
- **åœºæ™¯**: é˜²æ­¢ç”¨æˆ·åŒæ—¶å‘èµ·å¤šä¸ªæ‰¹æ”¹è¯·æ±‚
- **å®ç°**: åŸºäºRedisçš„åˆ†å¸ƒå¼é”ï¼Œæ”¯æŒè‡ªåŠ¨ç»­æœŸ
- **ç‰¹æ€§**: Watch Dogæœºåˆ¶ã€è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ã€å”¯ä¸€æ ‡è¯†é˜²è¯¯é‡Šæ”¾
- **ä½ç½®**: ç‹¬ç«‹çš„`lock`åŒ…ï¼ŒæŒ‰ä¸šåŠ¡åŠŸèƒ½ç»„ç»‡

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Go-Zero (å¾®æœåŠ¡æ¡†æ¶)
- **æ•°æ®åº“**: MongoDB
- **ç¼“å­˜**: Redis
- **ä¾èµ–æ³¨å…¥**: Google Wire
- **é“¾è·¯è¿½è¸ª**: OpenTelemetry + Jaeger
- **æ—¥å¿—**: go-zero å†…ç½®æ—¥å¿—ç³»ç»Ÿ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚
- Go 1.19+
- MongoDB 4.4+
- Redis 6.0+

### 2. å®‰è£…ä¾èµ–
```bash
go mod download
```

### 3. é…ç½®æ–‡ä»¶
å¤åˆ¶å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š
```bash
cp biz/infrastructure/config/config.local.yaml config.yaml
```

### 4. ç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç 
```bash
cd provider && wire
```

### 5. å¯åŠ¨æœåŠ¡
```bash
go run main.go
```

## ğŸ”§ å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°çš„ç¼“å­˜
éµå¾ªDDDåˆ†å±‚åŸåˆ™ï¼Œåœ¨ `infrastructure/cache/` ä¸­åˆ›å»ºæ–°çš„ç¼“å­˜æœåŠ¡ï¼š

```go
// 1. å®šä¹‰æ¥å£
type INewCacheService interface {
    Get(ctx context.Context, key string) (*DataType, error)
    Set(ctx context.Context, key string, data *DataType) error
}

// 2. å®ç°æ¥å£
type NewCacheService struct {
    rds *gozero_redis.Redis
}

// 3. æ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥
// åœ¨ provider/provider.go çš„ InfrastructureSet ä¸­æ·»åŠ 
```

### 2. æ·»åŠ æ–°çš„æ•°æ®ä»“å‚¨
åœ¨ `infrastructure/repository/` ä¸­åˆ›å»ºæ–°çš„æ•°æ®è®¿é—®å±‚ï¼š

```go
// 1. å®šä¹‰æ¥å£
type INewRepository interface {
    Insert(ctx context.Context, data *Model) error
    FindOne(ctx context.Context, id string) (*Model, error)
}

// 2. å®ç°æ¥å£ï¼ˆMongoDBï¼‰
type NewMongoMapper struct {
    conn *monc.Model
}

// 3. æ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥
func NewNewMongoMapper(config *config.Config) *NewMongoMapper {
    conn := monc.MustNewModel(config.Mongo.URL, config.Mongo.DB, "collection", config.Cache)
    return &NewMongoMapper{conn: conn}
}
```

### 3. ä½¿ç”¨åˆ†å¸ƒå¼é”
```go
// åœ¨Serviceä¸­ä½¿ç”¨åˆ†å¸ƒå¼é”
import "essay-show/biz/infrastructure/lock"

key := "operation_" + userId
distributedLock := lock.NewEvaMutex(ctx, key, initialExpire, maxTTL)
if err := distributedLock.Lock(); err != nil {
    return consts.ErrLockFailed
}
defer func() {
    if err := distributedLock.Unlock(); err != nil || distributedLock.Expired() {
        logx.Error("unlock failed: %v, expired: %v", err, distributedLock.Expired())
    }
}()
// æ‰§è¡Œéœ€è¦åŠ é”çš„ä¸šåŠ¡é€»è¾‘
```

### 4. Wire ä¾èµ–æ³¨å…¥
ä¿®æ”¹ä¾èµ–åï¼Œéœ€è¦é‡æ–°ç”Ÿæˆï¼š
```bash
cd provider && wire
```

### 5. ä»£ç è§„èŒƒ
- éµå¾ªDDDåˆ†å±‚æ¶æ„åŸåˆ™
- Serviceå±‚ä¸ç›´æ¥æ“ä½œåŸºç¡€è®¾æ–½
- é€šè¿‡æ¥å£æŠ½è±¡é™ä½è€¦åˆ
- Repositoryå±‚ä¸“æ³¨æ•°æ®è®¿é—®
- Cacheå±‚ä¸“æ³¨ç¼“å­˜é€»è¾‘
- Lockå±‚ä¸“æ³¨åˆ†å¸ƒå¼é”é€»è¾‘
- Rediså±‚æä¾›åŸºç¡€è®¾æ–½è¿æ¥
- ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ä¼˜åŒ–
- **ä¸‹è½½é“¾æ¥ç¼“å­˜**: 1å°æ—¶å†…é‡å¤è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
- **å“åº”æ—¶é—´**: ä»å‡ ç™¾æ¯«ç§’é™è‡³å‡ æ¯«ç§’
- **APIè°ƒç”¨**: å‡å°‘ä¸‹æ¸¸æœåŠ¡å‹åŠ›

### 2. åˆ†å¸ƒå¼é”ä¼˜åŒ–
- **å¹¶å‘æ§åˆ¶**: é˜²æ­¢ç”¨æˆ·é‡å¤æäº¤ï¼Œå‡å°‘èµ„æºç«äº‰
- **è‡ªåŠ¨ç»­æœŸ**: Watch Dogæœºåˆ¶ç¡®ä¿é•¿æ—¶é—´æ“ä½œä¸ä¼šé”è¶…æ—¶
- **æ€§èƒ½ç›‘æ§**: é”è·å–å’Œé‡Šæ”¾çš„è¯¦ç»†æ—¥å¿—
- **æ¶æ„æ¸…æ™°**: é”åŠŸèƒ½ç‹¬ç«‹äºç¼“å­˜å’Œè¿æ¥ç®¡ç†ï¼ŒæŒ‰ä¸šåŠ¡åŠŸèƒ½ç»„ç»‡

### 3. é“¾è·¯è¿½è¸ª
- é›†æˆOpenTelemetryï¼Œæ”¯æŒåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- å¯è§†åŒ–æ€§èƒ½ç“¶é¢ˆå®šä½

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **JWTè®¤è¯**: ç”¨æˆ·èº«ä»½éªŒè¯
- **æƒé™éªŒè¯**: ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- **å‚æ•°æ ¡éªŒ**: è¯·æ±‚å‚æ•°å®‰å…¨éªŒè¯
- **åˆ†å¸ƒå¼é”**: é˜²æ­¢å¹¶å‘æ“ä½œå†²çª
- **ç¼“å­˜éš”ç¦»**: ç”¨æˆ·æ•°æ®ç¼“å­˜éš”ç¦»

## ğŸ“ APIæ–‡æ¡£

æœåŠ¡å¯åŠ¨åè®¿é—®: `http://localhost:8888/swagger`

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. ç¬¦åˆDDDåŸåˆ™
- **Repositoryæ¨¡å¼**: æ•°æ®è®¿é—®å±‚æŠ½è±¡ï¼Œæ˜“äºæµ‹è¯•å’Œæ›¿æ¢
- **Cacheå±‚åˆ†ç¦»**: ç¼“å­˜é€»è¾‘ç‹¬ç«‹ï¼ŒèŒè´£å•ä¸€
- **Lockå±‚ç‹¬ç«‹**: åˆ†å¸ƒå¼é”é€»è¾‘ç‹¬ç«‹ï¼ŒæŒ‰ä¸šåŠ¡åŠŸèƒ½ç»„ç»‡
- **Rediså±‚åŸºç¡€**: æä¾›ç»Ÿä¸€çš„Redisè¿æ¥åŸºç¡€è®¾æ–½
- **æ¸…æ™°åˆ†å±‚**: æ¯å±‚èŒè´£æ˜ç¡®ï¼Œä¾èµ–å…³ç³»æ¸…æ™°

### 2. å¯ç»´æŠ¤æ€§
- **åˆ†å±‚æ¸…æ™°**: å„å±‚èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- **ä½è€¦åˆ**: é€šè¿‡æ¥å£æŠ½è±¡ï¼Œå±‚ä¸å±‚ä¹‹é—´æ¾è€¦åˆ
- **é«˜å†…èš**: ç›¸å…³åŠŸèƒ½èšåˆåœ¨åŒä¸€æ¨¡å—å†…
- **é¿å…é‡å¤**: ç§»é™¤å†—ä½™çš„é”æœåŠ¡ï¼Œä¿æŒä»£ç ç®€æ´

### 3. å¯æµ‹è¯•æ€§
- **æ¥å£æŠ½è±¡**: æ˜“äºmockå’Œå•å…ƒæµ‹è¯•
- **ä¾èµ–æ³¨å…¥**: æµ‹è¯•æ—¶å¯æ›¿æ¢ä¾èµ–
- **åˆ†å±‚éš”ç¦»**: å¯ä»¥ç‹¬ç«‹æµ‹è¯•å„å±‚

### 4. å¯æ‰©å±•æ€§
- **æ’ä»¶åŒ–**: æ–°åŠŸèƒ½å¯ä»¥é€šè¿‡æ–°çš„serviceæ‰©å±•
- **æŠ€æœ¯æ ˆæ›¿æ¢**: åŸºç¡€è®¾æ–½å±‚å¯ä»¥æ— ç¼æ›¿æ¢æŠ€æœ¯å®ç°
- **å¾®æœåŠ¡å‹å¥½**: æ˜“äºæ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

**å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æäº¤ Issue æˆ– PRï¼** ğŸ‰
